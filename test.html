<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="result">Testing...</div>
    <script>
        Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        console.log('ğŸ” CSV Parse Complete:', results);
        log(`ğŸ“Š CSV loaded: ${results.data.length} rows`);
        
        try {
            console.log('ğŸ” CSV Headers:', results.meta.fields);
            console.log('ğŸ” First Row:', results.data[0]);
            
            const songs = results.data
                .map(row => {
                    console.log('ğŸ” Processing row:', row);
                    return {
                        id: row.id?.trim() || row.ID?.trim() || `auto_${Math.random().toString(36).substr(2, 9)}`,
                        title: row.title?.trim(),
                        poet: row.poet?.trim(),
                        lyric: row.lyric?.trim(),
                        url: row.url?.trim()
                    };
                })
                .filter(song => {
                    const isValid = song.url && song.title && song.url.startsWith('http');
                    if (!isValid) {
                        console.log('ğŸ” Invalid song filtered out:', song);
                    }
                    return isValid;
                });

            console.log('ğŸ” Valid songs after filtering:', songs);
            log(`ğŸµ Valid songs found: ${songs.length}`);
            log(`ğŸ†” Sample song IDs: ${songs.slice(0, 3).map(s => s.id).join(', ')}`);

            if (songs.length === 0) {
                console.log('ğŸ” No valid songs found');
                titleEl.textContent = 'Ø®Ø·Ø§';
                titleEl.classList.remove('loading');
                lyricsEl.textContent = '';
                lyricsEl.classList.remove('loading');
                errorEl.textContent = 'Ù‡ÛŒÚ† Ø¢Ù‡Ù†Ú¯ Ù…Ø¹ØªØ¨Ø±ÛŒ Ø¯Ø± ÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
                log('âŒ No valid songs found');
                return;
            }

            console.log('ğŸ” Starting shuffle...');
            playlist = shuffleNoConsecutiveDuplicates(songs);
            console.log('ğŸ” Shuffle complete, playlist length:', playlist.length);
            
            const firstSong = playlist[0];
            console.log('ğŸ” First song:', firstSong);
            
            audio.src = firstSong.url;
            console.log('ğŸ” Audio source set');
            
            updateDisplay(firstSong);
            console.log('ğŸ” Display updated');
            
            // Start visual effects
            startVisualEffects();
            console.log('ğŸ” Visual effects started');
            
            audio.play().catch(e => {
                console.error('Initial playback failed:', e);
                clickHintEl.style.display = 'block';
            });
            
            log(`âœ… Player initialized with ${playlist.length} songs`);
            console.log('ğŸ” Initialization complete');
            
        } catch (error) {
            console.error('ğŸ” Error in CSV processing:', error);
            log(`âŒ Error processing CSV: ${error.message}`);
            errorEl.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: ${error.message}`;
        }
    },
    error: function(error) {
        console.error('ğŸ” Papa Parse Error:', error);
        console.error('Error loading CSV:', error);
        titleEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
        titleEl.classList.remove('loading');
        lyricsEl.textContent = '';
        lyricsEl.classList.remove('loading');
        errorEl.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
        log(`âŒ CSV loading failed: ${error.message}`);
    }
});
    </script>
</body>
</html>
