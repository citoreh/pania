<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="result">Testing...</div>
    <script>
        Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        console.log('🔍 CSV Parse Complete:', results);
        log(`📊 CSV loaded: ${results.data.length} rows`);
        
        try {
            console.log('🔍 CSV Headers:', results.meta.fields);
            console.log('🔍 First Row:', results.data[0]);
            
            const songs = results.data
                .map(row => {
                    console.log('🔍 Processing row:', row);
                    return {
                        id: row.id?.trim() || row.ID?.trim() || `auto_${Math.random().toString(36).substr(2, 9)}`,
                        title: row.title?.trim(),
                        poet: row.poet?.trim(),
                        lyric: row.lyric?.trim(),
                        url: row.url?.trim()
                    };
                })
                .filter(song => {
                    const isValid = song.url && song.title && song.url.startsWith('http');
                    if (!isValid) {
                        console.log('🔍 Invalid song filtered out:', song);
                    }
                    return isValid;
                });

            console.log('🔍 Valid songs after filtering:', songs);
            log(`🎵 Valid songs found: ${songs.length}`);
            log(`🆔 Sample song IDs: ${songs.slice(0, 3).map(s => s.id).join(', ')}`);

            if (songs.length === 0) {
                console.log('🔍 No valid songs found');
                titleEl.textContent = 'خطا';
                titleEl.classList.remove('loading');
                lyricsEl.textContent = '';
                lyricsEl.classList.remove('loading');
                errorEl.textContent = 'هیچ آهنگ معتبری در فایل یافت نشد.';
                log('❌ No valid songs found');
                return;
            }

            console.log('🔍 Starting shuffle...');
            playlist = shuffleNoConsecutiveDuplicates(songs);
            console.log('🔍 Shuffle complete, playlist length:', playlist.length);
            
            const firstSong = playlist[0];
            console.log('🔍 First song:', firstSong);
            
            audio.src = firstSong.url;
            console.log('🔍 Audio source set');
            
            updateDisplay(firstSong);
            console.log('🔍 Display updated');
            
            // Start visual effects
            startVisualEffects();
            console.log('🔍 Visual effects started');
            
            audio.play().catch(e => {
                console.error('Initial playback failed:', e);
                clickHintEl.style.display = 'block';
            });
            
            log(`✅ Player initialized with ${playlist.length} songs`);
            console.log('🔍 Initialization complete');
            
        } catch (error) {
            console.error('🔍 Error in CSV processing:', error);
            log(`❌ Error processing CSV: ${error.message}`);
            errorEl.textContent = `خطا در پردازش: ${error.message}`;
        }
    },
    error: function(error) {
        console.error('🔍 Papa Parse Error:', error);
        console.error('Error loading CSV:', error);
        titleEl.textContent = 'خطا در بارگذاری';
        titleEl.classList.remove('loading');
        lyricsEl.textContent = '';
        lyricsEl.classList.remove('loading');
        errorEl.textContent = 'لطفاً اتصال اینترنت را بررسی کنید یا فایل را بررسی کنید.';
        log(`❌ CSV loading failed: ${error.message}`);
    }
});
    </script>
</body>
</html>
